{% extends "base.html" %}
{% block content %}
<div class="container my-3">
    <a href="{{ url_for('site.create') }}" class="btn btn-primary" style="float: right;">í˜„ì¥ ë“±ë¡í•˜ê¸°</a>
    <h2>í˜„ì¥</h2>
    <div class="col-6">
        <!--í‚¤ì›Œë“œ ê²€ìƒ‰-->
        <div id="keyword-search" class="search-group">
            <input type="text" id="search_kw" class="form-control" value="{{ request.args.get('search_kw', '') }}">
            <button class="btn btn-outline-primary" type="button" id="btn_search">ì°¾ê¸°</button>
        </div>
        <div id="select-search" class="search-group">
            <!--ì‹œê³µ-->
            <div class="mb-3">
                <label for="service-filter" class="form-label">ì‹œê³µ</label>
                <select id="service-filter" class="form-select service-filter">
                    <option value="">ì „ì²´</option>
                    {% for service in services %}
                        <option value="{{ service.id }}"
                            {% if service.id in request.args.getlist('services') %}selected{% endif %}>
                            {{ service.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <!--ì—…ì²´-->
            <div class="mb-3">
                <label for="company-filter" class="form-label">ì—…ì²´</label>
                <select id="company-filter" class="form-select company-filter">
                    <option value="">ì „ì²´</option>
                    {% for company in companies %}
                        <option value="{{ company.id }}"
                            {% if company.id|string == request.args.get('company') %}selected{% endif %}>
                            {{ company.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <!--ìƒíƒœ-->
            <div class="mb-3">
                <label for="status-filter" class="form-label">ìƒíƒœ</label>
                <select id="status-filter" class="form-select status-filter">
                    <option value="">ì „ì²´</option>
                    {% for status in statuses %}
                        <option value="{{ status.id }}"
                            {% if status.id|string in request.args.getlist('statuses') %}selected{% endif %}>
                            {{ status.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <!--ê³„ì•½ì¼-->
            <div class="mb-3">
                <label for="contract-date-filter" class="form-label">ê³„ì•½ì¼</label>
                <input type="date" id="contract-date-filter" min="2023-01-01" max="2099-06-20" class="form-control" value="{{ request.args.get('contract_date', '') }}">
            </div>
            <!--ì„¸ê¸ˆ ì²˜ë¦¬-->
            <div class="mb-3">
                <label for="tax-filter" class="form-label">ì„¸ê¸ˆ ì²˜ë¦¬</label>
                <select id="tax-filter" class="form-select tax-filter">
                    <option value="">ì „ì²´</option>
                    {% for tax in taxes %}
                        <option value="{{ tax.id }}"
                            {% if tax.id in request.args.getlist('taxes') %}selected{% endif %}>
                            {{ tax.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <table class="table" style="width:70vw;">
        <thead>
            <tr class="table-primary">
                <th><a href="#" id="sort-district" data-order="asc">ì§€ì—­</a></th>
                <th><a href="#" id="sort-address" data-order="asc">ì£¼ì†Œ</a></th>
                <th><a href="#" id="sort-start-date" data-order="asc">ì‹œê³µ ë‚ ì§œ</a></th>
                <th><a href="#" id="sort-depositor" data-order="asc">ê³ ê°ëª…</a></th>
                <th><a href="#" id="sort-contract-date" data-order="asc">ê³„ì•½ì¼</a></th>
            </tr>
        </thead>
        <tbody>
            {% if site_list %}
                {% for site in site_list %}
                <tr>
                    <td>
                        <a href="{{ url_for('site.detail', site_id=site.id) }}">{{ site.district }}</a>
                    </td>
                    <td>
                        <a href="{{ url_for('site.detail', site_id=site.id) }}">{{ site.address }}</a>
                    </td>
                    <td>
                        <a href="{{ url_for('site.detail', site_id=site.id) }}">{{ site.works | map(attribute='start_date') | select | min }}</a>
                    </td>
                    <td>
                        <a href="{{ url_for('site.detail', site_id=site.id) }}">{{ site.depositor }}</a>
                    </td>
                    <td>
                        <span>{{ site.contract_date }}</span>
                    </td>

                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td colspan="3">í˜„ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ê²€ìƒ‰ ë²„íŠ¼ ìš”ì†Œë¥¼ ê°€ì ¸ì˜´
        const searchBtn = document.getElementById('btn_search');
    
        // ğŸ”¹ (1) í•„í„° select ìš”ì†Œë“¤ ëª¨ë‘ ê°€ì ¸ì™€ì„œ ë³€ê²½ ì‹œ í•„í„° ìë™ ì ìš©
        const allSelects = document.querySelectorAll('.form-select');
        allSelects.forEach(select => {
            select.addEventListener('change', applyFilters);
        });
    
        // ğŸ”¹ (2) ê³„ì•½ì¼(Date input)ë„ ë°”ë€Œë©´ ìë™ í•„í„° ì ìš©
        document.getElementById('contract-date-filter').addEventListener('change', applyFilters);
    
        // ğŸ”¹ (3) í‚¤ì›Œë“œ ê²€ìƒ‰ inputì—ì„œ 'ì—”í„°' í‚¤ ëˆŒë €ì„ ë•Œ ê²€ìƒ‰ ì‹¤í–‰
        document.getElementById('search_kw').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
                searchBtn.click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ê³¼ ê°™ì€ íš¨ê³¼
            }
        });
    
        // ğŸ”¹ (4) ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ í•„í„° ì‹¤í–‰
        searchBtn.addEventListener('click', applyFilters);
    
        // ğŸ”¹ (5) ì‹¤ì œ í•„í„°ë§ ë™ì‘ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜
        function applyFilters() {
            // í•„í„° ë°ì´í„°ë¥¼ ìˆ˜ì§‘
            const filters = {
                services: [],
                search_kw: document.getElementById('search_kw').value.trim(),
                company: document.getElementById('company-filter').value,
                statuses: [],
                contract_date: document.getElementById('contract-date-filter').value,
                taxes: []
            };
    
            // ì„ íƒëœ ì‹œê³µ ì„œë¹„ìŠ¤ ID ì¶”ê°€
            const selectedService = document.getElementById('service-filter').value;
            if (selectedService) filters.services.push(selectedService);
    
            // ì„ íƒëœ ìƒíƒœ ID ì¶”ê°€
            const selectedStatus = document.getElementById('status-filter').value;
            if (selectedStatus) filters.statuses.push(selectedStatus);
    
            // ì„ íƒëœ ì„¸ê¸ˆ ì²˜ë¦¬ ID ì¶”ê°€
            const selectedTax = document.getElementById('tax-filter').value;
            if (selectedTax) filters.taxes.push(selectedTax);
    
            // ğŸ”¹ URLSearchParamsë¥¼ ì‚¬ìš©í•´ì„œ íŒŒë¼ë¯¸í„° êµ¬ì„±
            const params = new URLSearchParams();
    
            // í‚¤ì›Œë“œ, ê³„ì•½ì¼, ì—…ì²´ ë“± ë‹¨ì¼ í•„í„° ì¶”ê°€
            if (filters.search_kw) params.append("search_kw", filters.search_kw);
            if (filters.contract_date) params.append("contract_date", filters.contract_date);
            if (filters.company) params.append("company", filters.company);
    
            // ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥í•œ í•­ëª©ë“¤ì€ ë°˜ë³µí•´ì„œ ì¶”ê°€
            filters.services.forEach(id => params.append("services", id));
            filters.statuses.forEach(id => params.append("statuses", id));
            filters.taxes.forEach(id => params.append("taxes", id));
    
            // ğŸ”¹ í˜„ì¬ í˜ì´ì§€ë¥¼ í•„í„°ë§ëœ URLë¡œ ë¦¬ë””ë ‰ì…˜
            window.location.href = `/sites?${params.toString()}`;
        }
    });
</script>

<!--thead í´ë¦­ìœ¼ë¡œ ì •ë ¬-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        function updateSorting(column) {
            const searchParams = new URLSearchParams(window.location.search);  // ê¸°ì¡´ í•„í„° ìœ ì§€
        
            // í˜„ì¬ ì •ë ¬ ìƒíƒœ ë°˜ëŒ€ë¡œ
            const currentSortBy = searchParams.get("sort_by");
            const currentOrder = searchParams.get("sort_order") || "asc";
        
            let newOrder = "asc";
            if (currentSortBy === column && currentOrder === "asc") {
                newOrder = "desc";
            }
        
            searchParams.set("sort_by", column);
            searchParams.set("sort_order", newOrder);
        
            // ê·¸ëŒ€ë¡œ ë¦¬ë””ë ‰ì…˜
            window.location.href = "{{ url_for('site.index') }}?" + searchParams.toString();
        }
    
        // ì •ë ¬ ê°€ëŠ¥í•œ í—¤ë” ëª©ë¡
        const sortableColumns = ["district", "address", "start-date", "depositor", "contract-date"];
    
        sortableColumns.forEach(column => {
            const element = document.getElementById("sort-" + column);
            if (element) {
                element.addEventListener("click", function (event) {
                    event.preventDefault();
                    updateSorting(column);
                });
    
                // í˜„ì¬ ì •ë ¬ ìƒíƒœë¥¼ URLì—ì„œ ì½ì–´ì™€ì„œ ë°˜ì˜
                const searchParams = new URLSearchParams(window.location.search);
                if (searchParams.get("sort_by") === column) {
                    const order = searchParams.get("sort_order");
                    element.setAttribute("data-order", order);
                    element.innerHTML = `${element.innerHTML} ${order === "asc" ? "â–²" : "â–¼"}`;
                }
            }
        });
    });
</script>

{% endblock %}