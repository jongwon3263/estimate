{% extends "base.html" %}
{% block content %}
<!--í˜„ì¥ ì •ë³´-->
<div class="container">
    <h5>í˜„ì¥ ì •ë³´</h5>

    <!-- ê¸°ì¡´ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
    <div id="site-info">
        <h2><span id="address_text">{{ site.address }}</span></h2>
        <ul>
            <li>ê±´ë¬¼ í˜•íƒœ: <span id="residence_type_text">{{ site.residence_type }}</span></li>
            <li>í‰ìˆ˜: <span id="room_size_text">{{ site.room_size }}</span></li>
            <li>ì…ê¸ˆìëª…: <span id="depositor_text">{{ site.depositor }}</span></li>
            <li>ê³ ê° ì—°ë½ì²˜: <span id="customer_phone_text">{{ site.customer_phone }}</span></li>
            <li>ì´ íŒë§¤ ê¸ˆì•¡: {{ site.customer_price | format_currency }}</li>
            <li>ê³„ì•½ê¸ˆ: {{ site.contract_deposit | format_currency }}</li>
            <li>ì”ê¸ˆ: {{ site.remaining_balance | format_currency }}</li>
            <li>ê³„ì•½ì¼: {{ site.contract_date }}</li>
            <li>ê±°ë˜ ìœ í˜•: {{ site.transaction_type }}</li>
        </ul>
        <button id="site-edit-btn" class="btn btn-warning">í˜„ì¥ì •ë³´ ìˆ˜ì •</button>
    </div>
    <!-- í˜„ì¥ì •ë³´ ìˆ˜ì • ì…ë ¥ í¼ (ì²˜ìŒì—” ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
    <div id="edit-form-1" style="display: none;">
        <form id="site-edit-form">
            {{ site_form.hidden_tag() }}

            <label for="address">ì£¼ì†Œ</label>
            {{ site_form.address(class="form-control", id="address") }}

            <label for="residence_type">ê±´ë¬¼ í˜•íƒœ</label>
            {{ site_form.residence_type(class="form-control", id="residence_type") }}

            <label for="room_size">í‰ìˆ˜</label>
            {{ site_form.room_size(class="form-control", id="room_size") }}

            <label for="depositor">ì…ê¸ˆìëª…</label>
            {{ site_form.depositor(class="form-control", id="depositor") }}

            <label for="customer_phone">ê³ ê° ì—°ë½ì²˜</label>
            {{ site_form.customer_phone(class="form-control", id="customer_phone") }}

            <label for="customer_price">ê³ ê° íŒë§¤ê°€</label>
            {{ site_form.customer_price(class="form-control", id="customer_price") }}

            <label for="contract_deposit">ê³„ì•½ê¸ˆ</label>
            {{ site_form.contract_deposit(class="form-control", id="contract_deposit") }}

            <label for="transaction_type">ê±°ë˜ ìœ í˜•</label>
            {{ site_form.transaction_type(class="form-control", id="transaction_type") }}

            <button type="submit" class="btn btn-success mt-3">ì €ì¥</button>
            <button type="button" id="cancel-btn" class="btn btn-secondary mt-3">ì·¨ì†Œ</button>
        </form>
    </div>
    <hr style="width:50%;">
    <!-- ì‹œê³µ ëª©ë¡ -->
    <div id="work-info">
        {% for work in site.work_set %}
            <!-- ê¸°ì¡´ ì •ë³´ í‘œì‹œ -->
            <div id="work-display-{{ work.id }}">
                <p><strong>ì‹œê³µ:</strong> <span id="service-{{ work.id }}">{{ work.service.name }}</span></p>
                <p><strong>ì—…ì²´:</strong> <span id="company-{{ work.id }}">{{ work.company.name if work.company else 'ë¯¸ì •' }}</span></p>
                <p><strong>ì‹œì‘:</strong> <span id="start_date-{{ work.id }}">{{ work.start_date }}</span></p>
                <p><strong>ì¢…ë£Œ:</strong> <span id="end_date-{{ work.id }}">{{ work.end_date }}</span></p>
                <p><strong>ì‘ì—… ì‹œê°„ëŒ€:</strong> <span id="work_time-{{ work.id }}">{{ work.work_time }}</span></p>
                <p><strong>ìƒì„¸ ì‚¬í•­:</strong> <span id="details-{{ work.id }}">{{ work.details }}</span></p>
                <p><strong>ë©”ëª¨:</strong> <span id="memo-{{ work.id }}">{{ work.memo }}</span></p>
                <p><strong>ì§„í–‰ ìƒí™©:</strong> <span id="status-{{ work.id }}">{{ work.status }}</span></p>
                <p><strong>ì—…ì²´ ë„ê¸‰ê°€:</strong> <span id="company_cost-{{ work.id }}">{{ work.company_cost | format_currency }}</span></p>
                <button class="btn btn-warning edit-btn" data-work-id="{{ work.id }}">ìˆ˜ì •</button>
            </div>

            <!-- ìˆ˜ì • ì…ë ¥ í¼ (ì²˜ìŒì—” ìˆ¨ê¹€) -->
            <div id="edit-form-{{ work.id }}" style="display: none;">
                <form class="work-edit-form" method="POST" action="{{ url_for('site.edit_work', work_id=work.id) }}" data-work-id="{{ work.id }}">
                    {{ work_edit_forms[work.id].hidden_tag() }}

                    <label for="service-{{ work.id }}">ì‹œê³µ</label>
                    <select class="form-control" id="service-{{ work.id }}" name="service">
                        <option value="">ì‹œê³µ ì„ íƒ</option>
                        {% for service in all_services %}
                            <option value="{{ service.id }}" {% if service.id == work.service_id %}selected{% endif %}>
                                {{ service.name }}
                            </option>
                        {% endfor %}
                    </select>

                    <label for="company-{{ work.id }}">ì—…ì²´</label>
                    <select class="form-control" id="company-{{ work.id }}" name="company">
                        <option value="">ì—…ì²´ ì„ íƒ</option>
                        {% for company in work_edit_forms[work.id].company.choices %}
                            <option value="{{ company[0] }}" {% if company[0] == work.company_id %}selected{% endif %}>
                                {{ company[1] }}
                            </option>
                        {% endfor %}
                    </select>

                    <label for="start_date-{{ work.id }}">ì‹œì‘</label>
                    {{ work_edit_forms[work.id].start_date(class="form-control", id="start_date-{{ work.id }}", value=work.start_date) }}

                    <label for="end_date-{{ work.id }}">ì¢…ë£Œ</label>
                    {{ work_edit_forms[work.id].end_date(class="form-control", id="end_date-{{ work.id }}", value=work.end_date) }}

                    <label for="work_time-{{ work.id }}">ì‘ì—… ì‹œê°„ëŒ€</label>
                    {{ work_edit_forms[work.id].work_time(class="form-control", id="work_time-{{ work.id }}", value=work.work_time) }}

                    <label for="details-{{ work.id }}">ìƒì„¸ ì‚¬í•­</label>
                    {{ work_edit_forms[work.id].details(class="form-control", id="details-{{ work.id }}", value=work.details) }}

                    <label for="memo-{{ work.id }}">ë©”ëª¨</label>
                    {{ work_edit_forms[work.id].memo(class="form-control", id="memo-{{ work.id }}", value=work.memo) }}

                    <label for="company_cost-{{ work.id }}">ì—…ì²´ ë„ê¸‰ê°€</label>
                    {{ work_edit_forms[work.id].company_cost(class="form-control", id="company_cost-{{ work.id }}", value=work.company_cost) }}

                    <label for="status-{{ work.id }}">ì§„í–‰ ìƒí™©</label>
                    {{ work_edit_forms[work.id].status(class="form-control", id="status-{{ work.id }}", value=work.status) }}

                    <button type="submit" class="btn btn-success mt-3">ì €ì¥</button>
                    <button type="button" class="btn btn-secondary cancel-btn" data-work-id="{{ work.id }}">ì·¨ì†Œ</button>
                </form>
            </div>
        <hr style="width:50%;">
        {% endfor %}
    </div>
    <div class="work-add-container">
        <h2>ì‹œê³µ ì¶”ê°€</h2>
        <form action="{{ url_for('work.add_work', site_id=site.id) }}" method="post" class="my-3">
            {{ work_add_form.hidden_tag() }}

            <label for="service">{{ work_add_form.service.label }}</label>
            {{ work_add_form.service(class="form-control", id="service") }}

            <label for="company">{{ work_add_form.company.label }}</label>
            <select id="company" name="company" class="form-control">
                <option value="">ì—…ì²´ ì„ íƒ</option>
            </select>

            <label for="start_date">{{ work_add_form.start_date.label }}</label>
            {{ work_add_form.start_date(class="form-control") }}

            <label for="end_date">{{ work_add_form.end_date.label }}</label>
            {{ work_add_form.end_date(class="form-control") }}

            <label for="company_cost">{{ work_add_form.company_cost.label }}</label>
            {{ work_add_form.company_cost(class="form-control", value=work_add_form.company_cost.data or 0) }}
            
            <label for="customer_price">{{ work_add_form.customer_price.label }}</label>
            {{ work_add_form.customer_price(class="form-control", value=work_add_form.customer_price.data or 0) }}

            <label for="work_time">{{ work_add_form.work_time.label }}</label>
            {{ work_add_form.work_time(class="form-control") }}

            <label for="details">{{ work_add_form.details.label }}</label>
            {{ work_add_form.details(class="form-control") }}

            <label for="memo">{{ work_add_form.memo.label }}</label>
            {{ work_add_form.memo(class="form-control") }}

            <label for="status">{{ work_add_form.status.label }}</label>
            {{ work_add_form.status(class="form-control") }}

            <button type="submit" class="btn btn-primary mt-3">ë“±ë¡</button>
        </form>
    </div>
</div>

<script>
    // ë‚ ì§œ ì„ íƒ ì œí•œ ê¸°ëŠ¥
    document.addEventListener("DOMContentLoaded", function() {
        let today = new Date().toISOString().split("T")[0];

        let startDateInput = document.getElementById("start_date");
        let endDateInput = document.getElementById("end_date");

        // ì‹œì‘ ë‚ ì§œëŠ” ì˜¤ëŠ˜ ì´í›„ë¡œë§Œ ì„ íƒ ê°€ëŠ¥
        startDateInput.setAttribute("min", today);

        startDateInput.addEventListener("change", function() {
            let selectedStartDate = startDateInput.value;
            endDateInput.setAttribute("min", selectedStartDate);
        });
    });

    // ì—…ì²´ í•„í„° ê¸°ëŠ¥
    function filterCompanies() {
        let selectedService = document.getElementById("service").value;
        let companySelect = document.getElementById("company");
        let options = companySelect.getElementsByTagName("option");

        for (let i = 1; i < options.length; i++) {
            let serviceId = options[i].getAttribute("data-service");
            if (selectedService === serviceId || selectedService === "") {
                options[i].style.display = "block";
            } else {
                options[i].style.display = "none";
            }
        }

        companySelect.value = "";
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // âœ… "ì‹œê³µ ì¶”ê°€" í¼ì˜ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
        let mainServiceDropdown = document.getElementById("service");
        let mainCompanyDropdown = document.getElementById("company");
    
        if (mainServiceDropdown) {
            mainServiceDropdown.addEventListener("change", function () {
                updateCompanyDropdown(this.value, mainCompanyDropdown);
            });
        }
    
        // âœ… "ì‹œê³µ ìˆ˜ì •" í¼ì˜ ê° ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
        document.querySelectorAll("[id^=service-]").forEach(serviceDropdown => {
            serviceDropdown.addEventListener("change", function () {
                let workId = this.id.split("-")[1];  // work.id ê°€ì ¸ì˜¤ê¸°
                let companyDropdown = document.getElementById("company-" + workId);
    
                updateCompanyDropdown(this.value, companyDropdown);
            });
        });
    
        // âœ… ì—…ì²´ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
        function updateCompanyDropdown(serviceId, companyDropdown) {
            if (!companyDropdown) return;
            
            // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
            companyDropdown.innerHTML = '<option value="">ì—…ì²´ ì„ íƒ</option>';
    
            if (serviceId) {
                fetch(`/get_companies/${serviceId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(company => {
                            let option = document.createElement("option");
                            option.value = company.id;
                            option.textContent = company.name;
                            companyDropdown.appendChild(option);
                        });
                    })
                    .catch(error => console.error("ì—…ì²´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
            }
        }
    });
</script>

<script>
    // í˜„ì¥ ìˆ˜ì •
    document.addEventListener("DOMContentLoaded", function() {
        const siteEditBtn = document.getElementById("site-edit-btn");
        const siteInfo = document.getElementById("site-info");
        const editForm1 = document.getElementById("edit-form-1");
        const cancelBtn = document.getElementById("cancel-btn");
        const editFormElement1 = document.getElementById("site-edit-form");

        // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì •ë³´ ìˆ¨ê¸°ê³  í¼ ë³´ì´ê¸°
        siteEditBtn.addEventListener("click", function() {
            siteInfo.style.display = "none";
            editForm1.style.display = "block";
        });

        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ìˆ¨ê¸°ê³  ê¸°ì¡´ ì •ë³´ ë³´ì´ê¸°
        cancelBtn.addEventListener("click", function() {
            editForm1.style.display = "none";
            siteInfo.style.display = "block";
        });

        // í¼ ì œì¶œ ì‹œ AJAXë¡œ ë°ì´í„° ì „ì†¡ (Flask APIë¡œ ì—…ë°ì´íŠ¸ ìš”ì²­)
        editFormElement1.addEventListener("submit", function(event) {
            event.preventDefault();

            const formData = new FormData(editFormElement1);

            fetch("{{ url_for('site.modify_site', site_id=site.id) }}", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // UI ì—…ë°ì´íŠ¸ (ì…ë ¥ëœ ê°’ì„ í™”ë©´ì— ë°˜ì˜)
                    document.getElementById("address_text").textContent = data.address;
                    document.getElementById("residence_type_text").textContent = data.residence_type;
                    document.getElementById("room_size_text").textContent = data.room_size;
                    document.getElementById("depositor_text").textContent = data.depositor;
                    document.getElementById("customer_phone_text").textContent = data.customer_phone;

                    // í¼ ìˆ¨ê¸°ê³  ê¸°ì¡´ ì •ë³´ ë‹¤ì‹œ í‘œì‹œ
                    editForm1.style.display = "none";
                    siteInfo.style.display = "block";
                    setTimeout(() => location.reload(), 10); // âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì¶”ê°€
                } else {
                    alert("ìˆ˜ì • ì‹¤íŒ¨: " + data.error);
                }
            })
            .catch(error => console.error("Error:", error));
        });
    });
</script>


<script>
    // ì‹œê³µ ìˆ˜ì •
    document.addEventListener("DOMContentLoaded", function() {
        // ëª¨ë“  'ìˆ˜ì •' ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelectorAll(".edit-btn").forEach(button => {
            button.addEventListener("click", function() {
                let workId = this.getAttribute("data-work-id");

                // ê¸°ì¡´ ì •ë³´ ìˆ¨ê¸°ê¸° & ìˆ˜ì • í¼ ë³´ì´ê¸°
                document.getElementById(`work-display-${workId}`).style.display = "none";
                document.getElementById(`edit-form-${workId}`).style.display = "block";
            });
        });

        // ëª¨ë“  'ì·¨ì†Œ' ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelectorAll(".cancel-btn").forEach(button => {
            button.addEventListener("click", function() {
                let workId = this.getAttribute("data-work-id");

                // ìˆ˜ì • í¼ ìˆ¨ê¸°ê¸° & ê¸°ì¡´ ì •ë³´ ë‹¤ì‹œ í‘œì‹œ
                document.getElementById(`edit-form-${workId}`).style.display = "none";
                document.getElementById(`work-display-${workId}`).style.display = "block";
            });
        });

        // ì‹œê³µ ìˆ˜ì • í¼ ì œì¶œ ì‹œ AJAX ìš”ì²­ ë³´ë‚´ê¸°
        document.querySelectorAll(".work-edit-form").forEach(form => {
            form.addEventListener("submit", function(event) {
                event.preventDefault();
                let workId = this.getAttribute("data-work-id");
                let formData = new FormData(this);

                console.log("ğŸ“¡ ìš”ì²­ ë³´ë‚´ëŠ” ë°ì´í„°:", Object.fromEntries(formData));

                fetch(`/edit_work/${workId}`, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest" // âœ… AJAX ìš”ì²­ì„ì„ ì„œë²„ì— ì•Œë¦¼
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log("ğŸ“© ì„œë²„ ì‘ë‹µ:", data);
                    if (data.success) {
                        // UI ì—…ë°ì´íŠ¸
                        document.getElementById(`service-${workId}`).textContent = data.service;
                        document.getElementById(`company-${workId}`).textContent = data.company;
                        document.getElementById(`start_date-${workId}`).textContent = data.start_date;
                        document.getElementById(`end_date-${workId}`).textContent = data.end_date;
                        document.getElementById(`work_time-${workId}`).textContent = data.work_time;
                        document.getElementById(`details-${workId}`).textContent = data.details;
                        document.getElementById(`memo-${workId}`).textContent = data.memo;
                        document.getElementById(`company_cost-${workId}`).textContent = data.company_cost;

                        // ìˆ˜ì • í¼ ìˆ¨ê¸°ê³  ê¸°ì¡´ ì •ë³´ ë‹¤ì‹œ í‘œì‹œ
                        document.getElementById(`edit-form-${workId}`).style.display = "none";
                        document.getElementById(`work-display-${workId}`).style.display = "block";
                        // alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        setTimeout(() => location.reload(), 350); // âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì¶”ê°€
                    } else {
                        alert("ìˆ˜ì • ì‹¤íŒ¨: " + data.error);
                    }
                })
                .catch(error => {
                    console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                });
            });
        });
    });
</script>
{% endblock %}